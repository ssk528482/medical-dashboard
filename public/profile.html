<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile â€” Medical Study OS</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<script src="router.js"></script>

<h1>ğŸ‘¤ Profile</h1>

<div id="profileContainer"></div>

<!-- Reset Confirmation Modal -->
<div id="resetModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:999;align-items:center;justify-content:center;padding:20px;">
  <div style="background:#1e293b;border:2px solid #ef4444;border-radius:16px;max-width:380px;width:100%;padding:24px;">

    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:40px;">âš ï¸</div>
      <div style="font-size:17px;font-weight:800;color:#fca5a5;margin-top:8px;">Reset Everything?</div>
    </div>

    <div style="background:#450a0a;border-radius:10px;padding:12px;font-size:13px;color:#fca5a5;margin-bottom:18px;line-height:1.6;">
      This will permanently erase:<br>
      â€¢ All subjects, units &amp; chapters<br>
      â€¢ All qbank stats<br>
      â€¢ All revision history &amp; analytics<br>
      â€¢ Your exam date &amp; daily plans<br><br>
      <strong>Your name will be kept.</strong> You'll be taken back to setup.
    </div>

    <label style="display:block;font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">
      Type <strong style="color:#ef4444;">RESET</strong> to confirm
    </label>
    <input type="text" id="resetConfirmInput" placeholder="Type RESET here"
      style="width:100%;margin-bottom:6px;border-color:#ef4444;"
      oninput="document.getElementById('resetError').textContent=''">
    <div id="resetError" style="color:#ef4444;font-size:12px;min-height:16px;margin-bottom:12px;"></div>

    <div style="display:flex;gap:10px;">
      <button onclick="closeResetModal()" style="flex:1;background:#334155;margin:0;">Cancel</button>
      <button onclick="confirmReset()" style="flex:1;background:#dc2626;margin:0;font-weight:700;">ğŸ—‘ï¸ Reset</button>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <a href="index.html">ğŸ <br>Plan</a>
  <a href="editor.html">ğŸ“š<br>Syllabus</a>
  <a href="analytics.html">ğŸ“Š<br>Stats</a>
  <a href="profile.html" class="active">ğŸ‘¤<br>Profile</a>
</div>

<script src="utils.js"></script>
<script src="data.js"></script>
<script src="revisionEngine.js"></script>
<script src="scheduler.js"></script>
<script src="intelligence.js"></script>
<script src="charts.js"></script>
<script src="supabase.js"></script>
<script>

function renderProfile() {
  let container = document.getElementById("profileContainer");
  if (!container) return;

  let phases        = getGlobalPhaseStats();
  let streak        = calculateStreak();
  let longestStreak = calculateLongestStreak();
  let daysLeft      = daysUntilExam();
  let weekly        = calculateWeeklyConsistency().toFixed(0);
  let monthly       = calculateMonthlyConsistency().toFixed(0);
  let burnout       = getBurnoutIndex();
  let completionPct = phases.total > 0 ? (phases.phase1.count / phases.total * 100).toFixed(1) : 0;

  container.innerHTML = `

    <!-- Identity -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:14px;">
        <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);
          display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">ğŸ©º</div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:18px;font-weight:700;">${studyData.userName || "Student"}</div>
          <div style="font-size:13px;color:#64748b;" id="displayEmail">Loading...</div>
          <div style="font-size:12px;color:#3b82f6;margin-top:2px;">ğŸ¯ Exam: ${studyData.examDate || "Not set"}</div>
        </div>
      </div>
    </div>

    <!-- Streaks -->
    <div class="card">
      <div class="section-title">ğŸ”¥ Streaks & Consistency</div>
      <div class="analytics-grid" style="grid-template-columns:1fr 1fr 1fr;">
        <div class="stat-box"><div class="stat-big" style="color:#f97316;">${streak}</div><div class="stat-label">Streak</div><div style="font-size:10px;color:#64748b;">days</div></div>
        <div class="stat-box"><div class="stat-big" style="color:#eab308;">${longestStreak}</div><div class="stat-label">Best</div><div style="font-size:10px;color:#64748b;">days</div></div>
        <div class="stat-box"><div class="stat-big" style="color:${burnout>50?"#ef4444":burnout>25?"#f59e0b":"#10b981"}">${burnout}</div><div class="stat-label">Burnout</div></div>
      </div>
      <div style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:#94a3b8;margin-bottom:4px;">
          <span>7-Day Consistency</span><span style="color:#3b82f6;">${weekly}%</span>
        </div>
        <div class="stat-bar"><div class="stat-fill" style="width:${weekly}%;background:#3b82f6;"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:12px;color:#94a3b8;margin:8px 0 4px;">
          <span>30-Day Consistency</span><span style="color:#8b5cf6;">${monthly}%</span>
        </div>
        <div class="stat-bar"><div class="stat-fill" style="width:${monthly}%;background:#8b5cf6;"></div></div>
      </div>
    </div>

    <!-- Progress -->
    <div class="card">
      <div class="section-title">ğŸ“š Study Progress</div>
      <div class="analytics-grid" style="grid-template-columns:1fr 1fr 1fr;">
        <div class="stat-box"><div class="stat-big" style="color:#3b82f6;">${completionPct}%</div><div class="stat-label">Completion</div></div>
        <div class="stat-box"><div class="stat-big" style="color:#f59e0b;">${daysLeft}</div><div class="stat-label">Days to Exam</div></div>
        <div class="stat-box"><div class="stat-big" style="color:#8b5cf6;">${phases.phase2.pct}%</div><div class="stat-label">Phase 2 (R1)</div></div>
      </div>
      <div class="analytics-grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:8px;">
        <div class="stat-box"><div class="stat-big" style="color:#10b981;">${phases.qbank.pct}%</div><div class="stat-label">Qbank</div></div>
        <div class="stat-box"><div class="stat-big" style="color:#06b6d4;">${phases.phase2.pct}%</div><div class="stat-label">Revision 1</div></div>
        <div class="stat-box"><div class="stat-big" style="color:#f97316;">${(phases.r3 || phases.phase3).pct}%</div><div class="stat-label">Revision 3</div></div>
      </div>
    </div>

    <!-- Settings -->
    <div class="card">
      <div class="section-title">âš™ï¸ Settings</div>
      <label style="font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:4px;">Your Name</label>
      <input type="text" id="settingName" value="${studyData.userName || ""}" style="width:100%;margin-bottom:12px;">
      <label style="font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:4px;">Exam Date</label>
      <input type="date" id="settingExamDate" value="${studyData.examDate || "2026-12-01"}" style="width:100%;margin-bottom:12px;">
      <label style="font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:4px;">Default Daily Hours</label>
      <input type="number" id="settingHours" value="${studyData.defaultHours || 8}" min="1" max="18" style="width:100%;margin-bottom:16px;">
      <button onclick="saveSettings()" style="width:100%;background:#16a34a;">Save Settings âœ“</button>
    </div>

    <!-- Logout -->
    <div class="card" style="border-color:#334155;">
      <div class="section-title">âš ï¸ Account</div>
      <button onclick="doLogout()" style="width:100%;background:#ef4444;margin-bottom:0;">Logout</button>
    </div>

    <!-- Reset Everything -->
    <div class="card" style="border-color:#7f1d1d;border-width:2px;">
      <div class="section-title" style="color:#fca5a5;">ğŸ—‘ï¸ Reset Everything</div>
      <div style="font-size:13px;color:#94a3b8;margin-bottom:12px;line-height:1.5;">
        Erase all study data, subjects, qbank, analytics, and history. Keeps your name. Takes you back to setup.
      </div>
      <button onclick="openResetModal()" style="width:100%;background:#dc2626;font-weight:700;">
        Reset Everything
      </button>
    </div>
  `;

  // Load email
  supabaseClient.auth.getUser().then(({ data: { user } }) => {
    let el = document.getElementById("displayEmail");
    if (el && user) el.textContent = user.email;
  });
}

function saveSettings() {
  studyData.userName    = document.getElementById("settingName").value.trim();
  studyData.examDate    = document.getElementById("settingExamDate").value;
  studyData.defaultHours = parseFloat(document.getElementById("settingHours").value) || 8;
  saveData();
  alert("Settings saved âœ“");
  renderProfile();
}

async function doLogout() {
  await supabaseClient.auth.signOut();
  localStorage.removeItem("studyData");
  window.location.href = "login.html";
}

// â”€â”€ Reset Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openResetModal() {
  document.getElementById("resetModal").style.display = "flex";
  document.getElementById("resetConfirmInput").value = "";
  document.getElementById("resetError").textContent = "";
}

function closeResetModal() {
  document.getElementById("resetModal").style.display = "none";
}

async function confirmReset() {
  let input = document.getElementById("resetConfirmInput").value.trim();
  if (input !== "RESET") {
    document.getElementById("resetError").textContent = 'âœ• Type the word RESET exactly (all caps).';
    return;
  }

  let name = studyData.userName || "";

  // Wipe everything â€” keep only name and start fresh
  studyData = {
    version: 4,
    setupComplete: false,
    userName: name,
    subjects: {},
    dailyHistory: {},
    dailyPlan: null,
    uiState: { editorCollapsed: {}, unitCollapsed: {} },
    startDate: today(),
    examDate: null,
    defaultHours: 8,
    updatedAt: new Date().toISOString()
  };

  localStorage.setItem("studyData", JSON.stringify(studyData));

  // Sync wipe to cloud
  if (typeof saveToCloud === "function") await saveToCloud();

  window.location.href = "setup.html";
}

</script>

</body>
</html>
