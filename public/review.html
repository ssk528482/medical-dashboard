<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.json">
  <title>Review — Medical Study OS</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .review-page { padding: 16px; padding-bottom: 80px; max-width: 680px; margin: 0 auto; }
    .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; font-size: 13px; color: var(--text-muted); }
    .review-title { font-size: 18px; font-weight: 700; color: var(--text); }
    #review-timer { font-variant-numeric: tabular-nums; font-weight: 600; color: var(--text-muted); }

    /* Progress bar */
    .progress-bar-wrap { margin-bottom: 6px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: var(--blue); transition: width 0.3s ease; width: 0%; }
    .progress-label { font-size: 11px; color: var(--text-dim); text-align: right; margin-bottom: 14px; }

    /* Card flip */
    #card-wrapper { perspective: 1200px; min-height: 260px; margin-bottom: 16px; cursor: pointer; }
    #review-card {
      width: 100%; min-height: 260px; position: relative;
      transform-style: preserve-3d;
      transition: transform 0.45s cubic-bezier(0.4,0,0.2,1);
      border-radius: 16px;
    }
    #review-card.flipped { transform: rotateY(180deg); }
    .card-face {
      position: absolute; width: 100%; min-height: 260px;
      backface-visibility: hidden; -webkit-backface-visibility: hidden;
      border-radius: 16px; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 28px; box-sizing: border-box;
      background: var(--surface); border: 1.5px solid var(--border);
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
    }
    .card-face.back { transform: rotateY(180deg); background: var(--card); }
    .card-face-text { font-size: 18px; font-weight: 500; text-align: center; color: var(--text); line-height: 1.5; }
    .card-face-img  { max-width: 100%; max-height: 160px; object-fit: contain; border-radius: 8px; margin-top: 12px; }
    .card-hint { margin-top: 12px; font-size: 12px; color: var(--text-dim); }

    /* Flip button */
    #btn-flip {
      width: 100%; padding: 14px; border-radius: 12px; border: none;
      background: var(--blue); color: #fff; font-size: 15px; font-weight: 700;
      cursor: pointer; margin-bottom: 12px; min-height: unset;
    }

    /* Rating buttons */
    #rating-btns { display: none; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 12px; }
    #rating-btns.visible { display: grid; }
    .rating-btn { padding: 12px 0; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; min-height: unset; margin: 0; transition: transform 0.1s; }
    .rating-btn:active { transform: scale(0.95); }
    .rating-btn[data-r="1"] { background: #fdecea; color: #c0392b; }
    .rating-btn[data-r="2"] { background: #fef3e2; color: #e67e22; }
    .rating-btn[data-r="3"] { background: #eafaf1; color: #27ae60; }
    .rating-btn[data-r="4"] { background: #eaf4fd; color: #2980b9; }

    /* Card actions (edit/delete) */
    #card-actions { display: none; justify-content: center; gap: 10px; margin-bottom: 12px; }
    #card-actions.visible { display: flex; }
    .card-action-btn {
      padding: 7px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: 1px solid var(--border); min-height: unset; margin: 0;
      background: var(--card); color: var(--text-muted);
    }
    .card-action-btn:hover { opacity: 0.85; box-shadow: none; }

    /* Streak badge */
    #streak-badge {
      display: inline-block; position: fixed; top: 70px; right: 20px;
      background: rgba(245,158,11,0.18); color: var(--yellow);
      border: 1px solid rgba(245,158,11,0.3); border-radius: 20px;
      padding: 4px 12px; font-size: 12px; font-weight: 700;
      opacity: 0; transition: opacity 0.3s;
    }
    #streak-badge.visible { opacity: 1; }

    /* Start / empty / complete screens */
    .review-screen {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 48px 24px; text-align: center; gap: 14px;
    }
    .review-big-icon { font-size: 56px; }
    .review-count-label { font-size: 26px; font-weight: 700; }
    .review-sub-label { font-size: 14px; color: var(--text-muted); }
    .btn-start {
      background: var(--blue); color: #fff; border: none; border-radius: 12px;
      padding: 14px 32px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 8px; min-height: unset;
    }
    .btn-back-browse {
      background: var(--card); color: var(--text-muted); border: 1px solid var(--border);
      border-radius: 12px; padding: 12px 24px; font-size: 14px; font-weight: 600;
      cursor: pointer; text-decoration: none; display: inline-block;
    }

    /* Summary grid */
    .summary-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 12px; margin: 12px 0; width: 100%; max-width: 320px; }
    .summary-cell { background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 14px; text-align: center; }
    .sc-value { font-size: 24px; font-weight: 700; }
    .sc-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .summary-cell.again .sc-value { color: #c0392b; }
    .summary-cell.hard  .sc-value { color: #e67e22; }
    .summary-cell.good  .sc-value { color: #27ae60; }
    .summary-cell.easy  .sc-value { color: #2980b9; }

    /* Undo / Redo row */
    #undo-redo-row {
      display: flex; gap: 8px; margin-bottom: 10px;
    }
    .undo-redo-btn {
      flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 8px 12px; border-radius: 9px; border: 1px solid var(--border);
      background: var(--card); color: var(--text-muted); font-size: 12px; font-weight: 700;
      cursor: pointer; min-height: unset; margin: 0; transition: background 0.15s, color 0.15s, opacity 0.15s;
    }
    .undo-redo-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .undo-redo-btn:not(:disabled):hover { background: var(--surface); color: var(--text); }
    #btn-undo:not(:disabled) { border-color: rgba(251,191,36,0.35); color: #fbbf24; }
    #btn-redo:not(:disabled) { border-color: rgba(99,102,241,0.35); color: #818cf8; }

    /* Inline edit modal */
    .edit-modal-backdrop {
      display: none; position: fixed; inset: 0; z-index: 600;
      background: rgba(0,0,0,0.65); backdrop-filter: blur(4px);
      align-items: center; justify-content: center; padding: 16px;
    }
    .edit-modal-backdrop.open { display: flex; }
    .edit-modal-sheet {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 22px; width: 100%; max-width: 480px;
    }
    .edit-modal-title { font-size: 15px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .edit-modal-close { background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 3px 9px; border-radius: 6px; font-size: 13px; cursor: pointer; margin: 0; min-height: unset; }
    .edit-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-dim); letter-spacing: .06em; display: block; margin-bottom: 4px; }
    .edit-textarea {
      width: 100%; background: var(--card); color: var(--text);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      padding: 9px 11px; font-size: 13px; font-family: inherit; resize: vertical;
      margin-bottom: 10px; min-height: unset;
    }
    .edit-textarea:focus { border-color: var(--blue); outline: none; }
    .edit-save-btn {
      width: 100%; background: var(--blue); color: #fff; border: none;
      padding: 10px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 700;
      cursor: pointer; margin: 0; min-height: unset;
    }

  </style>
</head>
<body>

<!-- ═══ SIDE NAV ═══ -->
<script src="nav.js"></script>

<!-- ═══ STREAK BADGE ═══ -->
<div id="streak-badge"></div>

<div class="review-page">

  <!-- START SCREEN -->
  <div id="screen-start" class="review-screen">
    <div class="review-big-icon">🔁</div>
    <div class="review-count-label" id="start-count">Loading…</div>
    <div class="review-sub-label"   id="start-sub"></div>
    <button class="btn-start" id="btn-start">Start Review</button>
    <a href="browse.html" class="btn-back-browse">← Back to Cards</a>
  </div>

  <!-- EMPTY SCREEN -->
  <div id="screen-empty" class="review-screen" style="display:none">
    <div class="review-big-icon">🎉</div>
    <div class="review-count-label">All caught up!</div>
    <div class="review-sub-label">No cards due for review today.</div>
    <a href="browse.html" class="btn-back-browse">← Browse Cards</a>
  </div>

  <!-- SESSION -->
  <div id="screen-session" style="display:none">
    <!-- Header row -->
    <div class="review-header">
      <div>
        <div class="review-title">🔁 Review</div>
        <div id="card-counter" style="font-size:12px;color:var(--text-dim);margin-top:2px;"></div>
      </div>
      <div id="review-timer">00:00</div>
    </div>

    <!-- Progress -->
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progress-fill"></div></div>
    <div class="progress-label" id="progress-label"></div>

    <!-- Flip card -->
    <div id="card-wrapper" onclick="flipCard()">
      <div id="review-card">
        <div class="card-face front" id="card-front">
          <div class="card-face-text" id="card-front-text"></div>
          <img  class="card-face-img"  id="card-front-img" src="" style="display:none"/>
          <div class="card-hint">Tap to reveal</div>
        </div>
        <div class="card-face back" id="card-back">
          <div class="card-face-text" id="card-back-text"></div>
          <img  class="card-face-img"  id="card-back-img" src="" style="display:none"/>
        </div>
      </div>
    </div>

    <!-- Undo / Redo -->
    <div id="undo-redo-row">
      <button class="undo-redo-btn" id="btn-undo" onclick="undoRating()" disabled title="Undo last rating (Ctrl+Z or U)">&#8592; Undo</button>
      <button class="undo-redo-btn" id="btn-redo" onclick="redoRating()" disabled title="Redo (Ctrl+Y or R)">Redo &#8594;</button>
    </div>

    <!-- Flip button -->
    <button id="btn-flip" onclick="flipCard()">Show Answer</button>

    <!-- Rating buttons -->
    <div id="rating-btns">
      <button class="rating-btn" data-r="1" onclick="rateCard(1)">😰 Again</button>
      <button class="rating-btn" data-r="2" onclick="rateCard(2)">😐 Hard</button>
      <button class="rating-btn" data-r="3" onclick="rateCard(3)">🙂 Good</button>
      <button class="rating-btn" data-r="4" onclick="rateCard(4)">😄 Easy</button>
      <!-- Keyboard shortcuts hint -->
      <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:8px;">
        <span class="kbd-hint">Space flip</span>
        <span class="kbd-hint">1 Again</span>
        <span class="kbd-hint">2 Hard</span>
        <span class="kbd-hint">3 Good</span>
        <span class="kbd-hint">4 Easy</span>
        <span class="kbd-hint">U Undo</span>
        <span class="kbd-hint">R Redo</span>
      </div>
    </div>

    <!-- Card actions (edit / delete) -->
    <div id="card-actions">
      <button class="card-action-btn" onclick="openEditModal()">✏️ Edit Card</button>
      <button class="card-action-btn" onclick="deleteCurrentCard()" style="color:var(--red);border-color:rgba(239,68,68,0.3)">🗑️ Delete</button>
    </div>
  </div>

  <!-- COMPLETE SCREEN -->
  <div id="screen-complete" class="review-screen" style="display:none">
    <div class="review-big-icon">🏆</div>
    <div class="review-count-label">Session Complete!</div>
    <div class="summary-grid">
      <div class="summary-cell again"><div class="sc-value" id="sum-again">0</div><div class="sc-label">Again</div></div>
      <div class="summary-cell hard"> <div class="sc-value" id="sum-hard">0</div> <div class="sc-label">Hard</div></div>
      <div class="summary-cell good"> <div class="sc-value" id="sum-good">0</div> <div class="sc-label">Good</div></div>
      <div class="summary-cell easy"> <div class="sc-value" id="sum-easy">0</div> <div class="sc-label">Easy</div></div>
    </div>
    <div class="review-sub-label" id="sum-retention"></div>
    <div class="review-sub-label" id="sum-time"></div>
    <div class="review-sub-label" id="sum-tomorrow"></div>
    <a href="browse.html" class="btn-back-browse" style="margin-top:8px;">← Back to Cards</a>
  </div>

</div><!-- /review-page -->

<!-- ═══ INLINE EDIT MODAL ═══ -->
<div class="edit-modal-backdrop" id="edit-modal" onclick="if(event.target===this)closeEditModal()">
  <div class="edit-modal-sheet">
    <div class="edit-modal-title">
      ✏️ Edit Card
      <button class="edit-modal-close" onclick="closeEditModal()">✕</button>
    </div>
    <span class="edit-label">Front</span>
    <textarea class="edit-textarea" id="edit-front" rows="3" placeholder="Front text…"></textarea>
    <span class="edit-label">Back</span>
    <textarea class="edit-textarea" id="edit-back"  rows="3" placeholder="Back text…"></textarea>
    <button class="edit-save-btn" onclick="saveEdit()">💾 Save Changes</button>
  </div>
</div>

<!-- ═══ SCRIPTS ═══ -->
<script src="utils.js"></script>
<script src="data.js"></script>
<script src="supabase.js"></script>
<script src="cardSync.js"></script>
<script src="imageOcclusion.js"></script>
<script src="review.js"></script>
<script src="rotateScreen.js"></script>
<script src="notifications.js"></script>
<script src="pomodoro.js"></script>
<script src="search.js"></script>
<script src="pwa.js"></script>
</body>
</html>
